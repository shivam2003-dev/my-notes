# Docker Troubleshooting Cheatsheet: Image Management Troubles

## Image Build Failures

### Dockerfile Syntax Errors

**Common Syntax Issues**
```dockerfile
# ❌ Wrong: Missing FROM
COPY . /app

# ✅ Correct: FROM must be first
FROM node:16
COPY . /app

# ❌ Wrong: Invalid instruction format
RUN apt-get update &&
    apt-get install -y curl

# ✅ Correct: Proper line continuation
RUN apt-get update && \
    apt-get install -y curl

# ❌ Wrong: Case sensitive instructions
run npm install

# ✅ Correct: Uppercase instructions
RUN npm install
```

**Syntax Validation Commands**
```bash
# Validate Dockerfile syntax
docker build --no-cache --dry-run .

# Parse Dockerfile with detailed output
docker build --progress=plain .

# Check Dockerfile with hadolint
docker run --rm -i hadolint/hadolint < Dockerfile
```

**Instruction-Specific Issues**
```bash
# COPY/ADD path issues
# ❌ Wrong: Source outside build context
COPY ../config.json /app/

# ✅ Correct: Source within build context
COPY config.json /app/

# ARG/ENV variable issues
# Check variable expansion
docker build --build-arg APP_ENV=prod .
docker inspect <image> | grep -A 10 "Env"
```

### Build Context Issues

**Large Build Context**
```bash
# Check build context size
du -sh .
du -sh * | sort -hr

# Optimize with .dockerignore
echo "node_modules" >> .dockerignore
echo ".git" >> .dockerignore
echo "*.log" >> .dockerignore
echo ".env" >> .dockerignore

# Build with specific context
docker build -f Dockerfile.prod ./src
```

**Missing Files in Context**
```bash
# List build context contents
tar -tzf - < <(docker build -q .) 2>/dev/null

# Debug build context
docker build --progress=plain --no-cache .

# Check file permissions
ls -la
stat Dockerfile
```

**Path Resolution Problems**
```bash
# Absolute vs relative paths
WORKDIR /app
COPY package.json .              # Copies to /app/
COPY package.json /app/         # Explicit path

# Debug WORKDIR issues
docker run --rm <image> pwd
docker run --rm <image> ls -la
```

### Layer Caching Problems

**Cache Invalidation Issues**
```bash
# Force rebuild without cache
docker build --no-cache .

# Rebuild from specific stage
docker build --target production .

# Check build cache usage
docker build --progress=plain .
```

**Optimize Caching Strategy**
```dockerfile
# ❌ Wrong: Changes invalidate all subsequent layers
COPY . /app
RUN npm install

# ✅ Correct: Copy dependencies first
COPY package*.json /app/
RUN npm install
COPY . /app
```

**Cache Debugging**
```bash
# Show image layers and sizes
docker history <image_name>

# Compare layer differences
docker diff <container_id>

# Check layer cache hits
docker build --progress=plain . 2>&1 | grep -E "CACHED|RUN"
```

## Registry Issues

### Push/Pull Failures

**Network Connectivity**
```bash
# Test registry connectivity
curl -v https://registry-1.docker.io/v2/
curl -v https://your-registry.com/v2/

# Check DNS resolution
nslookup registry-1.docker.io
dig registry-1.docker.io

# Test with different registry
docker pull alpine:latest
docker pull gcr.io/google-containers/pause:latest
```

**Registry Configuration**
```bash
# Check Docker daemon registry settings
cat /etc/docker/daemon.json

# Configure insecure registry
{
  "insecure-registries": ["registry.local:5000"],
  "registry-mirrors": ["https://mirror.registry.com"]
}

# Restart Docker after config changes
sudo systemctl restart docker
```

**Image Tagging Issues**
```bash
# Check current tags
docker images | grep <image_name>

# Proper tagging for push
docker tag <local_image> <registry>/<repository>:<tag>
docker tag myapp:latest registry.company.com/myapp:v1.0

# Push with explicit tag
docker push registry.company.com/myapp:v1.0
```

### Authentication Problems

**Login Issues**
```bash
# Login to Docker Hub
docker login

# Login to private registry
docker login registry.company.com
docker login -u username -p password registry.company.com

# Check stored credentials
cat ~/.docker/config.json

# Clear stored credentials
docker logout
rm ~/.docker/config.json
```

**Credential Store Issues**
```bash
# Check credential helper
docker-credential-desktop list
docker-credential-osxkeychain list

# Configure credential store
{
  "credsStore": "desktop",
  "credHelpers": {
    "registry.company.com": "custom-helper"
  }
}
```

**Token Authentication**
```bash
# Use access tokens instead of passwords
docker login -u username --password-stdin

# AWS ECR login
aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin <account>.dkr.ecr.us-east-1.amazonaws.com

# GCP Container Registry
gcloud auth configure-docker
```

### Rate Limiting

**Docker Hub Rate Limits**
```bash
# Check rate limit status
curl -s -I "https://auth.docker.io/token?service=registry.docker.io&scope=repository:library/alpine:pull" | grep -i ratelimit

# Login to increase limits
docker login

# Use authenticated pulls
docker pull --platform=linux/amd64 alpine:latest
```

**Alternative Registries**
```bash
# Use mirror registries
docker pull mirror.gcr.io/library/alpine:latest

# Configure daemon with mirrors
{
  "registry-mirrors": [
    "https://mirror.gcr.io",
    "https://registry.mirror.com"
  ]
}
```

## Image Size Optimization

### Large Images Analysis

**Image Size Inspection**
```bash
# Check image sizes
docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

# Analyze layers
docker history <image_name>
docker history --no-trunc <image_name>

# Use dive tool for detailed analysis
docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock wagoodman/dive:latest <image_name>
```

**Layer Size Analysis**
```bash
# Show layer sizes
docker history --format "table {{.CreatedBy}}\t{{.Size}}" <image_name>

# Find largest layers
docker history <image_name> | sort -k2 -hr

# Export and analyze filesystem
docker save <image_name> | tar -tv
```

### Inefficient Layers

**Combine RUN Commands**
```dockerfile
# ❌ Wrong: Multiple layers
RUN apt-get update
RUN apt-get install -y curl
RUN apt-get install -y vim
RUN apt-get clean

# ✅ Correct: Single layer
RUN apt-get update && \
    apt-get install -y curl vim && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*
```

**Minimize Layer Count**
```dockerfile
# ❌ Wrong: Many layers
COPY file1.txt /app/
COPY file2.txt /app/
COPY file3.txt /app/

# ✅ Correct: Single COPY layer
COPY file1.txt file2.txt file3.txt /app/
# Or better:
COPY files/ /app/
```

### Cleanup Strategies

**Remove Unnecessary Files**
```dockerfile
# Clean package caches
RUN apt-get update && \
    apt-get install -y python3 && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

# Remove build dependencies
RUN apk add --no-cache --virtual .build-deps \
        gcc musl-dev && \
    pip install some-package && \
    apk del .build-deps
```

**Use Appropriate Base Images**
```dockerfile
# ❌ Large: Full OS image
FROM ubuntu:20.04

# ✅ Better: Minimal image
FROM alpine:3.18

# ✅ Best: Distroless image
FROM gcr.io/distroless/python3

# ✅ Scratch for static binaries
FROM scratch
COPY binary /
ENTRYPOINT ["/binary"]
```

**Multi-stage Optimization**
```dockerfile
# Build stage with all tools
FROM node:16 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# Production stage with minimal footprint
FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
```

## Multi-stage Build Problems

### Stage Reference Errors

**Named Stage Issues**
```dockerfile
# ❌ Wrong: Undefined stage name
FROM node:16 AS build
RUN npm install
FROM alpine
COPY --from=builder /app /app

# ✅ Correct: Match stage names
FROM node:16 AS builder
RUN npm install
FROM alpine
COPY --from=builder /app /app
```

**Stage Ordering Problems**
```dockerfile
# ❌ Wrong: Forward reference
COPY --from=final /app/dist /dist
FROM node:16 AS builder
FROM nginx AS final

# ✅ Correct: Stages must be defined before use
FROM node:16 AS builder
FROM nginx AS final
COPY --from=builder /app/dist /usr/share/nginx/html
```

### Artifact Copying Issues

**Path Resolution in COPY --from**
```dockerfile
# Debug stage contents
FROM node:16 AS builder
WORKDIR /app
COPY . .
RUN npm run build
RUN ls -la /app/dist  # Debug: check if dist exists

FROM nginx:alpine
# Copy with absolute paths
COPY --from=builder /app/dist /usr/share/nginx/html
```

**Missing Files Between Stages**
```bash
# Debug intermediate stages
docker build --target builder -t debug-stage .
docker run --rm -it debug-stage ls -la /app/

# Check file permissions
docker run --rm -it debug-stage stat /app/dist
```

**Build Context in Multi-stage**
```dockerfile
# Each stage gets the same build context
FROM alpine AS stage1
COPY file.txt /stage1/

FROM alpine AS stage2
COPY file.txt /stage2/          # Gets from build context, not stage1
COPY --from=stage1 /stage1/ /   # Gets from stage1
```

### Advanced Multi-stage Debugging

**Build Specific Stages**
```bash
# Build only up to specific stage
docker build --target builder .
docker build --target test .

# Build all stages for debugging
docker build --target stage1 -t debug1 .
docker build --target stage2 -t debug2 .
```

**Inspect Stage Outputs**
```bash
# Run intermediate stage
docker run --rm -it debug1 /bin/sh

# Compare stages
docker diff $(docker create debug1)
docker diff $(docker create debug2)

# Export stage filesystem
docker save debug1 | tar -tv
```

## Quick Diagnostic Commands

### Build Debugging
```bash
# Verbose build output
docker build --progress=plain --no-cache .

# Build with specific Dockerfile
docker build -f Dockerfile.debug .

# Build with build args
docker build --build-arg ENV=debug --build-arg VERSION=1.0 .
```

### Registry Troubleshooting
```bash
# Test registry API
curl -v https://registry-1.docker.io/v2/
curl -v https://registry-1.docker.io/v2/library/alpine/tags/list

# Check authentication
docker login --username <user>
cat ~/.docker/config.json | jq .
```

### Size Analysis Tools
```bash
# Quick size check
docker images | head -10

# Detailed layer analysis
docker history --no-trunc <image> | head -20

# System-wide cleanup
docker system df
docker system prune -a
```

## Quick Fixes Reference

| Problem | Diagnostic Command | Quick Fix |
|---------|-------------------|-----------|
| Build fails on COPY | `ls -la <file>` | Check file exists in build context |
| Large image size | `docker history <image>` | Use multi-stage builds |
| Push authentication fails | `docker login` | Re-authenticate with registry |
| Cache not working | `docker build --progress=plain .` | Reorder Dockerfile for better caching |
| Stage not found | `docker build --target <stage> .` | Check stage name spelling |
| Registry timeout | `curl -v <registry-url>/v2/` | Check network/DNS |
| Layer too large | `docker history <image> \| head` | Combine RUN commands |
| Missing build context | `tar -tzf - < <(docker build -q .)` | Add files to context or .dockerignore |

## Optimization Checklist

**Dockerfile Best Practices**
- [ ] Use appropriate base image (alpine, distroless)
- [ ] Combine RUN commands
- [ ] Order instructions by change frequency
- [ ] Use .dockerignore to exclude unnecessary files
- [ ] Clean up package caches in same RUN command
- [ ] Use multi-stage builds for compiled languages

**Registry Optimization**
- [ ] Use authentication to avoid rate limits
- [ ] Configure registry mirrors
- [ ] Tag images appropriately
- [ ] Use layer caching effectively
- [ ] Compress build context when possible

This comprehensive guide covers image management troubles with practical solutions and optimization strategies.

Sources
